# Unbound Recursive Resolver Configuration
# For NSEC Cache Datastore Demo
#
# Key feature: aggressive-nsec (RFC 8198) enabled
# This allows the resolver to synthesize NXDOMAIN responses
# for names within cached NSEC intervals WITHOUT contacting
# the authoritative server.

server:
    # Interface settings
    interface: 0.0.0.0
    port: 53
    
    # Protocol settings
    do-ip4: yes
    do-ip6: no
    do-udp: yes
    do-tcp: yes
    
    # Access control - allow all (demo only)
    access-control: 0.0.0.0/0 allow
    access-control: 172.28.0.0/16 allow
    
    # ============================================
    # DNSSEC Validation Settings
    # ============================================
    
    # We'll add the trust anchor dynamically in entrypoint
    # auto-trust-anchor-file: "/var/lib/unbound/root.key"
    
    # Strict DNSSEC validation
    val-clean-additional: yes
    val-permissive-mode: no
    harden-dnssec-stripped: yes
    
    # ============================================
    # RFC 8198 - Aggressive NSEC Caching
    # THIS IS THE KEY SETTING FOR THE DEMO
    # ============================================
    aggressive-nsec: yes
    
    # ============================================
    # Cache Settings
    # ============================================
    
    # Cache sizes
    msg-cache-size: 4m
    rrset-cache-size: 8m
    key-cache-size: 4m
    neg-cache-size: 1m
    
    # Cache TTL bounds
    cache-min-ttl: 0
    cache-max-ttl: 86400
    cache-max-negative-ttl: 3600
    
    # Prefetch for better cache hit rates
    prefetch: no
    prefetch-key: no
    
    # ============================================
    # Logging Settings
    # ============================================
    
    # Verbosity: 0=errors, 1=warnings, 2=info, 3+=debug
    verbosity: 2
    
    # Log to file
    use-syslog: no
    logfile: "/var/log/unbound/unbound.log"
    
    # Log query details (helpful for debugging)
    log-queries: yes
    log-replies: yes
    log-servfail: yes
    log-local-actions: yes
    
    # Extended statistics
    extended-statistics: yes
    statistics-interval: 0
    statistics-cumulative: yes
    
    # ============================================
    # Performance Settings
    # ============================================
    
    num-threads: 1
    msg-cache-slabs: 1
    rrset-cache-slabs: 1
    infra-cache-slabs: 1
    key-cache-slabs: 1
    
    # Serve expired while fetching
    serve-expired: no
    
    # Don't use caps-for-id (cleaner responses)
    use-caps-for-id: no
    
    # Minimal responses
    minimal-responses: yes
    
    # Hide identity and version
    hide-identity: yes
    hide-version: yes
    
    # Hardening
    harden-glue: yes
    harden-short-bufsize: yes
    harden-large-queries: yes
    
    # Root hints not needed - we forward everything
    root-hints: ""
    
    # Chroot disabled for easier debugging
    chroot: ""
    
    # Directory for runtime data
    directory: "/var/lib/unbound"
    
    # User
    username: "unbound"
    
    # PID file
    pidfile: "/var/run/unbound.pid"

# ============================================
# Forward Zone Configuration
# Forward zone.test. queries to our authoritative server
# ============================================
forward-zone:
    name: "zone.test."
    forward-addr: 172.28.0.2

# ============================================
# Remote Control (for stats queries)
# ============================================
remote-control:
    control-enable: yes
    control-interface: 127.0.0.1
    control-port: 8953
    control-use-cert: no
